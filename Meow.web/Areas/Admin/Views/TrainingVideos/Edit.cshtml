@model TrainingVideoEditViewModel
@{
    ViewData["Title"] = "編輯影片";
    var tags = (IReadOnlyList<Meow.Shared.Dtos.Tags.TagDto>)ViewBag.AllTags;
    var selected = Model?.TagIds ?? new List<Guid>();
}

<div class="container my-4">
    <h3 class="mb-3">編輯影片</h3>

    @if (TempData["Ok"] is string ok)
    {
        <div class="alert alert-success alert-dismissible fade show">@ok<button class="btn-close" data-bs-dismiss="alert"></button></div>
    }
    @if (TempData["Err"] is string err)
    {
        <div class="alert alert-danger alert-dismissible fade show">@err<button class="btn-close" data-bs-dismiss="alert"></button></div>
    }

    <form asp-action="Edit" method="post" enctype="multipart/form-data">
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="VideoId" />

        <div class="row g-3">
            <div class="col-lg-8">
                <div class="mb-3">
                    <label asp-for="Title" class="form-label fw-bold"></label>
                    <input asp-for="Title" class="form-control" />
                    <span asp-validation-for="Title" class="text-danger"></span>
                </div>

                <div class="row g-3">
                    <div class="col-md-6">
                        <label asp-for="BodyPart" class="form-label fw-bold"></label>
                        <input asp-for="BodyPart" class="form-control" />
                    </div>
                    <div class="col-md-6">
                        <label asp-for="DurationSec" class="form-label fw-bold">時長（秒）</label>
                        <input asp-for="DurationSec" type="number" min="0" class="form-control" />
                    </div>
                </div>

                <div class="mb-3">
                    <label asp-for="Url" class="form-label fw-bold">影片網址</label>
                    <input asp-for="Url" class="form-control" />
                </div>

                <div class="mb-3">
                    <label asp-for="Status" class="form-label fw-bold">狀態</label>
                    <select asp-for="Status" class="form-select">
                        <option value="Published">Published</option>
                        <option value="Draft">Draft</option>
                        <option value="Archived">Archived</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">標籤</label>
                    <div class="row row-cols-2 g-2">
                        @foreach (var t in tags)
                        {
                            var isChecked = selected.Contains(t.TagId);
                            <div class="col">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="TagIds" value="@t.TagId" id="tag_@t.TagId"
                                           @(isChecked ? "checked" : null) />
                                    <label class="form-check-label" for="tag_@t.TagId">@t.Name</label>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <div class="d-grid">
                    <button type="submit" class="btn btn-primary">儲存</button>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="mb-3">
                    <label class="form-label fw-bold">封面圖（上傳檔）</label>
                    <input type="file" name="ThumbnailFile" accept="image/*" class="form-control" id="thumbFile" />
                    <div class="mt-2">
                        <img id="thumbPreview"
                             src="@(string.IsNullOrWhiteSpace(Model?.ThumbnailUrl) ? "" : Model.ThumbnailUrl)"
                             class="rounded border" style="max-width:220px;@(string.IsNullOrWhiteSpace(Model?.ThumbnailUrl) ? "display:none" : "")" />
                    </div>
                    <div class="form-text">選擇檔案後會即時預覽，按「儲存」才會上傳。</div>
                </div>

                <div class="mb-3">
                    <label asp-for="ThumbnailUrl" class="form-label fw-bold">封面圖（URL）</label>
                    <input asp-for="ThumbnailUrl" class="form-control" />
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        document.getElementById('thumbFile')?.addEventListener('change', e=>{
          const [f] = e.target.files||[];
          const img = document.getElementById('thumbPreview');
          if (f) { img.src = URL.createObjectURL(f); img.style.display=''; }
        });
    </script>
}
