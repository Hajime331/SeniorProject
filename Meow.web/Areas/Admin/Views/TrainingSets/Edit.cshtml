@model TrainingSetEditViewModel
@{
    ViewData["Title"] = "編輯課表";
    var tags = (IReadOnlyList<Meow.Shared.Dtos.Tags.TagDto>)ViewBag.AllTags;
}

<div class="container my-4">
    <h3 class="mb-3">編輯課表</h3>

    @* 成功/失敗訊息 *@
    @if (TempData["Ok"] is string okMsg)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @okMsg
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["Err"] is string errMsg)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @errMsg
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <form asp-action="Edit" method="post" enctype="multipart/form-data">
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="SetId" />

        <div class="row g-3">
            <div class="col-lg-8">

                <div class="mb-3">
                    <label asp-for="Name" class="form-label fw-bold"></label>
                    <input asp-for="Name" class="form-control" />
                    <span asp-validation-for="Name" class="text-danger"></span>
                </div>

                <div class="row g-3">
                    <div class="col-md-6">
                        <label asp-for="BodyPart" class="form-label fw-bold">訓練部位</label>
                        <input asp-for="BodyPart" class="form-control" />
                    </div>
                    <div class="col-md-6">
                        <label asp-for="Equipment" class="form-label fw-bold">器材</label>
                        <input asp-for="Equipment" class="form-control" />
                    </div>
                    <div class="col-md-6">
                        <label asp-for="Difficulty" class="form-label fw-bold">難度</label>
                        <input asp-for="Difficulty" class="form-control" />
                    </div>
                    <div class="col-md-6">
                        <label asp-for="EstimatedDurationSec" class="form-label fw-bold">預估秒數</label>
                        <input asp-for="EstimatedDurationSec" class="form-control" type="number" min="0" />
                    </div>
                </div>

                <hr>

                <h5 class="mb-2">課表項目 Items</h5>

                <div id="items">
                    @for (int i = 0; i < Model.Items.Count; i++)
                    {
                        <div class="card mb-2 training-item" data-index="@i">
                            <div class="card-body">
                                <div class="row g-2 align-items-end">
                                    <input type="hidden" name="Items[@i].SetItemId" value="@Model.Items[i].SetItemId" />

                                    <div class="col-12">
                                        <label class="form-label">影片</label>
                                        <input type="hidden" name="Items[@i].VideoId" value="@Model.Items[i].VideoId" class="video-id" />
                                        <input type="text" class="form-control video-search"
                                               placeholder="輸入關鍵字搜尋影片…" data-target="#video-list-@i" autocomplete="off" />
                                        <div class="list-group position-absolute w-100 shadow-sm d-none"
                                             id="video-list-@i" style="z-index:1000; max-height:240px; overflow:auto;"></div>
                                        <small class="text-muted">已選：<span class="chosen-title">@Model.Items[i].VideoId</span></small>
                                    </div>

                                    <div class="col-3">
                                        <label class="form-label">順序</label>
                                        <input name="Items[@i].OrderNo" class="form-control" type="number" value="@Model.Items[i].OrderNo" />
                                    </div>
                                    <div class="col-3">
                                        <label class="form-label">次數</label>
                                        <input name="Items[@i].TargetReps" class="form-control" type="number" value="@Model.Items[i].TargetReps" />
                                    </div>
                                    <div class="col-3">
                                        <label class="form-label">休息秒</label>
                                        <input name="Items[@i].RestSec" class="form-control" type="number" value="@Model.Items[i].RestSec" />
                                    </div>
                                    <div class="col-3">
                                        <label class="form-label">回合</label>
                                        <input name="Items[@i].Rounds" class="form-control" type="number" value="@Model.Items[i].Rounds" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <button type="button" class="btn btn-outline-secondary btn-sm mb-3" id="btnAddItem">
                    新增一列
                </button>

                <div class="d-grid">
                    <button type="submit" class="btn btn-primary">儲存</button>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="mb-3">
                    <label class="form-label fw-bold">封面圖</label>
                    <input asp-for="CoverFile" type="file" class="form-control" accept="image/*" id="coverFile" />
                    <div class="mt-2">
                        <img id="coverPreview"
                             src="@(string.IsNullOrWhiteSpace(Model?.CoverUrl) ? "" : Model.CoverUrl)"
                             class="rounded border" style="max-width:220px;@(string.IsNullOrWhiteSpace(Model?.CoverUrl) ? "display:none" : "")" />
                    </div>
                    <div class="form-text">選擇檔案後會即時預覽，按「儲存」才會上傳。</div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">標籤</label>
                    @{
                        var selected = Model?.TagIds ?? new List<Guid>();
                    }
                    <div class="row row-cols-2 g-2">
                        @foreach (var t in tags)
                        {
                            var isChecked = selected.Contains(t.TagId);
                            <div class="col">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="TagIds" value="@t.TagId"
                                           id="tag_@t.TagId" @(isChecked ? "checked" : null) />
                                    <label class="form-check-label" for="tag_@t.TagId">@t.Name</label>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        // 即時預覽封面
        (function(){
          const input = document.getElementById('coverFile');
          const preview = document.getElementById('coverPreview');
          if (input && preview) {
            input.addEventListener('change', e => {
              const [file] = e.target.files || [];
              if (file) { preview.src = URL.createObjectURL(file); preview.style.display=''; }
            });
          }
        })();

        // 影片搜尋（與 Create 共用）
        const debounce = (fn, d=250) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), d);} };

        async function fetchVideos(q){
          if(!q || q.length < 2) return [];
          const res = await fetch('@Url.Action("SearchVideos")?q='+encodeURIComponent(q));
          if(!res.ok) return [];
          return await res.json();
        }

        function bindVideoSearch(container){
          const input  = container.querySelector('.video-search');
          const list   = document.querySelector(input.dataset.target);
          const hidden = container.querySelector('.video-id');
          const chosen = container.querySelector('.chosen-title');

          const render = (items) => {
            list.innerHTML = '';
            items.forEach(v=>{
              const a = document.createElement('a');
              a.href="#"; a.className="list-group-item list-group-item-action";
              const mins = v.durationSec ? Math.round(v.durationSec/60) : 0;
              a.textContent = `${v.title} • ${mins} 分`;
              a.addEventListener('click', e=>{
                e.preventDefault();
                hidden.value = v.videoId;
                chosen.textContent = v.title;
                list.classList.add('d-none'); input.value='';
              });
              list.appendChild(a);
            });
            list.classList.toggle('d-none', items.length===0);
          };

          input.addEventListener('input', debounce(async ()=>{
            const q = input.value.trim();
            render(await fetchVideos(q));
          }));

          document.addEventListener('click', (e)=>{
            if(!container.contains(e.target)) list.classList.add('d-none');
          });
        }

        document.querySelectorAll('.training-item').forEach(bindVideoSearch);

        // 動態新增列
        document.getElementById('btnAddItem')?.addEventListener('click', ()=>{
          const items = document.getElementById('items');
          const i = items.querySelectorAll('.training-item').length;
          const html = `
          <div class="card mb-2 training-item" data-index="${i}">
            <div class="card-body">
              <div class="row g-2 align-items-end">
                <input type="hidden" name="Items[${i}].SetItemId" />
                <div class="col-12">
                  <label class="form-label">影片</label>
                  <input type="hidden" name="Items[${i}].VideoId" class="video-id" />
                  <input type="text" class="form-control video-search" placeholder="輸入關鍵字搜尋影片…" data-target="#video-list-${i}" autocomplete="off" />
                  <div class="list-group position-absolute w-100 shadow-sm d-none" id="video-list-${i}" style="z-index:1000; max-height:240px; overflow:auto;"></div>
                  <small class="text-muted">已選：<span class="chosen-title"></span></small>
                </div>
                <div class="col-3">
                  <label class="form-label">順序</label>
                  <input name="Items[${i}].OrderNo" class="form-control" type="number" value="${i+1}" />
                </div>
                <div class="col-3">
                  <label class="form-label">次數</label>
                  <input name="Items[${i}].TargetReps" class="form-control" type="number" />
                </div>
                <div class="col-3">
                  <label class="form-label">休息秒</label>
                  <input name="Items[${i}].RestSec" class="form-control" type="number" />
                </div>
                <div class="col-3">
                  <label class="form-label">回合</label>
                  <input name="Items[${i}].Rounds" class="form-control" type="number" value="1" />
                </div>
              </div>
            </div>
          </div>`;
          items.insertAdjacentHTML('beforeend', html);
          const last = items.querySelector('.training-item:last-child');
          bindVideoSearch(last);
        });
    </script>
}
