@model TrainingSetEditViewModel
@using System.Linq
@{
    ViewData["Title"] = "編輯課表";
    var tags = (IReadOnlyList<Meow.Shared.Dtos.Tags.TagDto>)ViewBag.AllTags;
    var videos = ViewBag.AllVideos as IEnumerable<Meow.Shared.Dtos.Videos.TrainingVideoListItemDto>
                 ?? Enumerable.Empty<Meow.Shared.Dtos.Videos.TrainingVideoListItemDto>();
    Func<Guid, string> titleFor = id => videos.FirstOrDefault(v => v.VideoId == id)?.Title ?? string.Empty;
    var items = (Model.Items != null && Model.Items.Count > 0)
        ? Model.Items
        : new List<TrainingSetItemEditViewModel>();
    var selectedTags = new HashSet<Guid>(Model.TagIds ?? new List<Guid>());
}

<div class="container my-4">
    <h3 class="mb-3">編輯課表</h3>

    @if (TempData["Ok"] is string okMsg)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @okMsg
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["Err"] is string errMsg)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @errMsg
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <form asp-action="Edit" method="post" enctype="multipart/form-data">
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="SetId" />

        <div class="row g-3">
            <div class="col-lg-8">
                <div class="mb-3">
                    <label asp-for="Name" class="form-label fw-bold"></label>
                    <input asp-for="Name" class="form-control" />
                    <span asp-validation-for="Name" class="text-danger"></span>
                </div>

                <div class="row g-3">
                    <div class="col-md-6">
                        <label asp-for="BodyPart" class="form-label fw-bold">訓練部位</label>
                        <input asp-for="BodyPart" class="form-control" />
                    </div>
                    <div class="col-md-6">
                        <label asp-for="Equipment" class="form-label fw-bold">器材</label>
                        <input asp-for="Equipment" class="form-control" />
                    </div>
                    <div class="col-md-6">
                        <label asp-for="Difficulty" class="form-label fw-bold">難度</label>
                        <input asp-for="Difficulty" class="form-control" />
                    </div>
                    <div class="col-md-6">
                        <label asp-for="EstimatedDurationSec" class="form-label fw-bold">預估時長 (秒)</label>
                        <input asp-for="EstimatedDurationSec" class="form-control" type="number" min="0" />
                    </div>
                </div>

                <hr />

                <h5 class="mb-2">課表項目</h5>
                <div id="items">
                    @for (var i = 0; i < items.Count; i++)
                    {
                        var item = items[i];
                        <div class="card mb-2 training-item" data-index="@i">
                            <div class="card-body">
                                <div class="row g-2 align-items-end">
                                    <input type="hidden" name="Items[@i].SetItemId" value="@item.SetItemId" />
                                    <div class="col-12">
                                        <label class="form-label">影片</label>
                                        <input type="hidden" name="Items[@i].VideoId" class="video-id"
                                               value="@(item.VideoId == Guid.Empty ? string.Empty : item.VideoId.ToString())" />
                                        <input type="text" class="form-control video-search"
                                               placeholder="輸入關鍵字搜尋影片"
                                               data-target="#video-list-@i"
                                               autocomplete="off"
                                               value="@titleFor(item.VideoId)" />
                                        <div class="list-group position-absolute w-100 shadow-sm d-none"
                                             id="video-list-@i" style="z-index:1000; max-height:240px; overflow:auto;"></div>
                                    </div>
                                    <div class="col-3">
                                        <label class="form-label">排序</label>
                                        <input name="Items[@i].OrderNo" class="form-control" type="number" value="@item.OrderNo" />
                                    </div>
                                    <div class="col-3">
                                        <label class="form-label">次數</label>
                                        <input name="Items[@i].TargetReps" class="form-control" type="number" value="@(item.TargetReps?.ToString() ?? string.Empty)" />
                                    </div>
                                    <div class="col-3">
                                        <label class="form-label">休息秒數</label>
                                        <input name="Items[@i].RestSec" class="form-control" type="number" value="@(item.RestSec?.ToString() ?? string.Empty)" />
                                    </div>
                                    <div class="col-3">
                                        <label class="form-label">回合</label>
                                        <input name="Items[@i].Rounds" class="form-control" type="number" value="@(item.Rounds?.ToString() ?? string.Empty)" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <button type="button" class="btn btn-outline-secondary btn-sm mb-3" id="btnAddItem">新增項目</button>

                <div class="d-grid">
                    <button type="submit" class="btn btn-primary">儲存修改</button>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="mb-3">
                    <label class="form-label fw-bold">封面圖片</label>
                    <input asp-for="CoverFile" type="file" class="form-control" accept="image/*" id="coverFile" />
                    <div class="mt-2">
                        @if (!string.IsNullOrWhiteSpace(Model.CoverUrl))
                        {
                            <img id="coverPreview" src="@Model.CoverUrl" class="rounded border" style="max-width:220px;" />
                        }
                        else
                        {
                            <img id="coverPreview" class="rounded border" style="max-width:220px;display:none" />
                        }
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">標籤</label>
                    <div class="row row-cols-2 g-2">
                        @foreach (var tag in tags)
                        {
                            <div class="col">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="TagIds" value="@tag.TagId"
                                           id="tag_@tag.TagId" @(selectedTags.Contains(tag.TagId) ? "checked" : null) />
                                    <label class="form-check-label" for="tag_@tag.TagId">@tag.Name</label>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        (function(){
          const input = document.getElementById('coverFile');
          const preview = document.getElementById('coverPreview');
          if (input && preview) {
            input.addEventListener('change', e => {
              const [file] = e.target.files || [];
              if (file) {
                preview.src = URL.createObjectURL(file);
                preview.style.display='';
              }
            });
          }
        })();

        async function fetchVideos(q){
          if(!q || q.length < 2) return [];
          const res = await fetch('@Url.Action("SearchVideos")?q='+encodeURIComponent(q));
          return res.ok ? await res.json() : [];
        }

        function bindVideoSearch(container){
          const input  = container.querySelector('.video-search');
          const hidden = container.querySelector('.video-id');
          const list   = document.querySelector(input.dataset.target);

          input.addEventListener('input', async ()=>{
            const q = input.value.trim();
            const data = await fetchVideos(q);
            list.innerHTML = '';
            data.forEach(v=>{
              const a = document.createElement('a');
              a.href="#"; a.className="list-group-item list-group-item-action";
              a.textContent = v.title;
              a.addEventListener('click', e=>{
                e.preventDefault();
                hidden.value = v.videoId;
                input.value  = v.title;
                list.classList.add('d-none');
              });
              list.appendChild(a);
            });
            list.classList.toggle('d-none', data.length===0);
          });

          document.addEventListener('click', (e)=>{
            if(!container.contains(e.target)) list.classList.add('d-none');
          });
        }

        document.querySelectorAll('.training-item').forEach(bindVideoSearch);

        document.getElementById('btnAddItem')?.addEventListener('click', ()=>{
          const items = document.getElementById('items');
          const i = items.querySelectorAll('.training-item').length;
          const html = `
          <div class="card mb-2 training-item" data-index="${i}">
            <div class="card-body">
              <div class="row g-2 align-items-end">
                <input type="hidden" name="Items[${i}].SetItemId" />
                <div class="col-12">
                  <label class="form-label">影片</label>
                  <input type="hidden" name="Items[${i}].VideoId" class="video-id" value="" />
                  <input type="text" class="form-control video-search" placeholder="輸入關鍵字搜尋影片" data-target="#video-list-${i}" autocomplete="off" />
                  <div class="list-group position-absolute w-100 shadow-sm d-none" id="video-list-${i}" style="z-index:1000; max-height:240px; overflow:auto;"></div>
                </div>
                <div class="col-3"><label class="form-label">排序</label><input name="Items[${i}].OrderNo" class="form-control" type="number" value="${i+1}" /></div>
                <div class="col-3"><label class="form-label">次數</label><input name="Items[${i}].TargetReps" class="form-control" type="number" /></div>
                <div class="col-3"><label class="form-label">休息秒數</label><input name="Items[${i}].RestSec" class="form-control" type="number" /></div>
                <div class="col-3"><label class="form-label">回合</label><input name="Items[${i}].Rounds" class="form-control" type="number" value="1" /></div>
              </div>
            </div>
          </div>`;
          items.insertAdjacentHTML('beforeend', html);
          bindVideoSearch(items.lastElementChild);
        });
    </script>
}




