@using System.Globalization
@using Meow.Shared.Dtos.TrainingSessions
@model TrainingSessionDetailDto

@{
    ViewData["Title"] = "訓練明細";
    var isCompleted = Model.CompletedFlag || Model.EndedAt.HasValue;
    string FormatUtc(DateTime dt) => dt.ToLocalTime().ToString("yyyy/MM/dd HH:mm", CultureInfo.InvariantCulture);
    var minutes = Model.EndedAt.HasValue
        ? Math.Max(0, (int)(Model.EndedAt.Value - Model.StartedAt).TotalMinutes)
        : (int?)null;
}

<h2 class="mb-3">訓練明細</h2>

<!-- 概要卡 -->
<div class="card mb-3">
    <div class="card-body">
        <div class="d-flex flex-wrap align-items-center justify-content-between">
            <div class="me-3">
                <div class="fw-bold fs-5">@Model.SetName</div>
                <div class="text-muted small">
                    開始：@FormatUtc(Model.StartedAt)
                    @if (Model.EndedAt.HasValue)
                    {
                        <span class="ms-3">結束：@FormatUtc(Model.EndedAt.Value)</span>
                        <span class="ms-3">時長：@minutes 分</span>
                    }
                </div>
                @if (!string.IsNullOrWhiteSpace(Model.Notes))
                {
                    <div class="small mt-1">備註：@Model.Notes</div>
                }
            </div>

            <div class="text-end">
                @if (isCompleted)
                {
                    <span class="badge text-bg-success">已完成</span>
                }
                else
                {
                    <span class="badge text-bg-warning text-dark">進行中</span>
                }
            </div>
        </div>
    </div>
</div>

<!-- 結束訓練（非 AJAX）：送到 TrainingSessionsController.Complete -->
<div class="card mb-4">
    <div class="card-header">結束訓練</div>
    <div class="card-body">
        <form asp-action="Complete" method="post" class="row g-3">
            @Html.AntiForgeryToken()
            <input type="hidden" name="id" value="@Model.SessionID" />

            <div class="col-12 col-md-4">
                <label class="form-label">消耗卡路里 (kcal)</label>
                <input type="number" class="form-control" name="calories" min="0" step="1" @(isCompleted ? "disabled" : null) />
            </div>

            <div class="col-12 col-md-4">
                <label class="form-label">獲得點數</label>
                <input type="number" class="form-control" name="points" min="0" step="1" @(isCompleted ? "disabled" : null) />
            </div>

            <div class="col-12">
                <label class="form-label">備註</label>
                <textarea class="form-control" name="note" rows="2" placeholder="想記錄些什麼？" @(isCompleted ? "disabled" : null)></textarea>
            </div>

            <div class="col-12 d-flex gap-2">
                <a class="btn btn-outline-secondary" asp-action="Index">回清單</a>
                <button type="submit" class="btn btn-danger" @(isCompleted ? "disabled" : null)
                        onclick="return confirm('確定要結束這場訓練嗎？');">
                    結束訓練
                </button>
            </div>
        </form>

        @if (isCompleted)
        {
            <div class="text-muted small mt-2">
                這場訓練已於 @FormatUtc(Model.EndedAt ?? Model.StartedAt) 結束。
                你仍可於清單或此頁查看內容。
            </div>
        }
    </div>
</div>

<!-- 項目列表 -->
<div class="card">
    <div class="card-header">訓練步驟</div>
    <div class="card-body">
        @if (Model.Items?.Any() == true)
        {
            <div class="table-responsive">
                <table class="table align-middle">
                    <thead>
                        <tr>
                            <th style="width: 60px;">#</th>
                            <th>影片 / 動作</th>
                            <th style="width: 110px;">狀態</th>
                            <th style="width: 90px;">次數</th>
                            <th style="width: 90px;">重量</th>
                            <th style="width: 110px;">時長(秒)</th>
                            <th style="width: 110px;">休息(秒)</th>
                            <th style="width: 90px;">回合</th>
                            <th>備註</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var i in Model.Items.OrderBy(x => x.OrderNo))
                        {
                            <tr>
                                <td>@i.OrderNo</td>
                                <td>@i.VideoTitle</td>
                                <td>@i.Status</td>
                                <td>@(i.ActualReps?.ToString() ?? "-")</td>
                                <td>@(i.ActualWeight?.ToString() ?? "-")</td>
                                <td>@(i.ActualDurationSec?.ToString() ?? "-")</td>
                                <td>@(i.ActualRestSec?.ToString() ?? "-")</td>
                                <td>@(i.RoundsDone?.ToString() ?? "-")</td>
                                <td>@(string.IsNullOrWhiteSpace(i.Note) ? "-" : i.Note)</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div class="text-muted">沒有步驟項目。</div>
        }
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}
