@model Meow.Web.ViewModels.TrainingVideos.TrainingVideoIndexVm
@using Microsoft.AspNetCore.Mvc.Rendering

@{
    ViewData["Title"] = "影片清單";
    string currentUrl = Context.Request.Path + Context.Request.QueryString;
}

<h2 class="mb-3">影片清單</h2>

@if (TempData["Ok"] is string okMsg)
{
    <div class="alert alert-success">@okMsg</div>
}
@if (TempData["Error"] is string errMsg)
{
    <div class="alert alert-danger">@errMsg</div>
}

<form method="get" class="mb-4">
    <div class="row g-2 align-items-end">
        <div class="col-md-4">
            <label class="form-label">關鍵字</label>
            <input type="text" name="keyword" class="form-control"
                   placeholder="搜尋影片標題..." value="@Model.Keyword" />
        </div>
        <div class="col-md-3">
            <label class="form-label">狀態</label>
            @{
                var statusItems = new List<SelectListItem>
                        {
                        new("（全部）",""),
                        new("Draft","Draft"),
                        new("Published","Published"),
                        new("Archived","Archived"),
                        };
            }

            <select asp-for="Status" asp-items="statusItems" class="form-select"></select>
        </div>
    </div>

    <div class="mt-3">
        <div class="form-label">標籤（可多選，任一符合）</div>
        <div class="row row-cols-2 row-cols-md-4 g-2">
            @foreach (var t in Model.AllTags)
            {
                var isChecked = Model.SelectedTagIds.Contains(t.TagId);
                <div class="col">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox"
                               name="tagIds" value="@t.TagId" id="tag_@t.TagId"
                               @(isChecked ? "checked" : null) />
                        <label class="form-check-label" for="tag_@t.TagId">@t.Name</label>
                    </div>
                </div>
            }
        </div>
    </div>

    <button type="submit" class="btn btn-primary mt-3">篩選</button>
</form>

@if (Model.Videos?.Any() == true)
{
    <div class="list-group">
        @foreach (var v in Model.Videos)
        {
            <div class="list-group-item">
                <div class="d-flex justify-content-between">
                    <div class="me-3">
                        <div class="fw-bold">@v.Title</div>
                        <div class="small text-muted">
                            @v.BodyPart · 時長：@v.DurationSec 秒
                        </div>
                        <div class="small mt-1">
                            <a href="@v.Url" target="_blank" class="text-decoration-none">開啟影片連結 ↗</a>
                        </div>
                        @* 若你想顯示標籤名稱，可在 API 投影補 TagNames；這裡目前只有 TagIds *@
                        @if (v.TagIds?.Any() == true)
                        {
                            <div class="small text-muted mt-1">
                                標籤數：@v.TagIds.Count
                            </div>
                        }
                    </div>

                    <div class="text-end">
                        <div>
                            @if (v.Status == "Published")
                            {
                                <span class="badge text-bg-success">Published</span>
                            }
                            else if (v.Status == "Draft")
                            {
                                <span class="badge text-bg-secondary">Draft</span>
                            }
                            else
                            {
                                <span class="badge text-bg-dark">Archived</span>
                            }
                        </div>

                        <div class="mt-2 d-flex gap-2 justify-content-end">
                            @* 快速切換狀態 *@
                            <form asp-action="UpdateStatus" method="post" class="d-inline">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@v.VideoId" />
                                <input type="hidden" name="status" value="Published" />
                                <input type="hidden" name="returnUrl" value="@currentUrl" />
                                <button class="btn btn-sm btn-outline-success"
                                        type="submit" @(v.Status == "Published" ? "disabled" : null)>
                                    發佈
                                </button>
                            </form>
                            <form asp-action="UpdateStatus" method="post" class="d-inline">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@v.VideoId" />
                                <input type="hidden" name="status" value="Draft" />
                                <input type="hidden" name="returnUrl" value="@currentUrl" />
                                <button class="btn btn-sm btn-outline-secondary"
                                        type="submit" @(v.Status == "Draft" ? "disabled" : null)>
                                    轉草稿
                                </button>
                            </form>
                            <form asp-action="UpdateStatus" method="post" class="d-inline">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@v.VideoId" />
                                <input type="hidden" name="status" value="Archived" />
                                <input type="hidden" name="returnUrl" value="@currentUrl" />
                                <button class="btn btn-sm btn-outline-dark"
                                        type="submit" @(v.Status == "Archived" ? "disabled" : null)>
                                    封存
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
}
else
{
    <div class="text-muted">沒有符合條件的影片。</div>
}
