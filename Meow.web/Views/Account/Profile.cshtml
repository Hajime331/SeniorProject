@model AccountProfileVm
@{
    ViewData["Title"] = "會員中心 - 個人資料";
    var placeholder = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='120' height='120'><rect width='120' height='120' fill='%23dddddd'/><text x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='18' fill='%23666'>Avatar</text></svg>";
    var avatarSrc = string.IsNullOrWhiteSpace(Model.AvatarUrl) ? placeholder : Model.AvatarUrl;
}

<h2>會員中心 - 個人資料</h2>

<form asp-action="Profile" method="post" enctype="multipart/form-data" class="mt-3">
    @Html.AntiForgeryToken()

    <div class="row g-4">
        <div class="col-12 col-lg-6">
            <div class="mb-3">
                <label asp-for="Email" class="form-label"></label>
                <input asp-for="Email" class="form-control" readonly />
            </div>
            <div class="mb-3">
                <label asp-for="Nickname" class="form-label"></label>
                <input asp-for="Nickname" class="form-control" />
                <span asp-validation-for="Nickname" class="text-danger"></span>
            </div>
            <div class="mb-3">
                <label asp-for="BirthDate" class="form-label"></label>
                <input asp-for="BirthDate" type="date" class="form-control" />
                <span asp-validation-for="BirthDate" class="text-danger"></span>
            </div>
            <div class="mb-3">
                <label asp-for="Gender" class="form-label"></label>
                <select asp-for="Gender" class="form-select">
                    <option value="">-- 請選擇 --</option>
                    <option value="Male">男</option>
                    <option value="Female">女</option>
                    <option value="Other">其他</option>
                </select>
                <span asp-validation-for="Gender" class="text-danger"></span>
            </div>
            <div class="mb-3">
                <label asp-for="HeightCm" class="form-label"></label>
                <input asp-for="HeightCm" class="form-control" />
                <span asp-validation-for="HeightCm" class="text-danger"></span>
            </div>
            <div class="mb-3">
                <label asp-for="WeightKg" class="form-label"></label>
                <input asp-for="WeightKg" class="form-control" />
                <span asp-validation-for="WeightKg" class="text-danger"></span>
            </div>
        </div>

        <div class="col-12 col-lg-6">
            <div class="card shadow-sm mb-3">
                <div class="card-body">
                    <label class="form-label fw-bold">當前頭貼</label>
                    <div class="d-flex flex-column flex-md-row align-items-start gap-3">
                        <img id="avatarPreview" src="@avatarSrc" alt="頭貼預覽"
                             class="rounded-circle border" style="width:120px;height:120px;object-fit:cover;" />
                        <div class="flex-grow-1">
                            <label class="form-label">上傳新頭貼</label>
                            <input asp-for="AvatarFile" type="file" class="form-control" accept="image/*" />
                            <span asp-validation-for="AvatarFile" class="text-danger"></span>
                            <div class="form-text">支援 JPG、PNG、WEBP，檔案大小上限 5MB。</div>
                        </div>
                    </div>
                </div>
            </div>

            @if (Model.Avatars != null && Model.Avatars.Count > 0)
            {
                <div class="mb-3">
                    <label class="form-label fw-bold">選擇預設頭貼</label>
                    <div class="row row-cols-2 row-cols-md-4 g-3">
                        @foreach (var avatar in Model.Avatars)
                        {
                            <div class="col text-center">
                                <input type="radio" name="AvatarID"
                                       value="@avatar.AvatarID"
                                       id="avatar_@avatar.AvatarID"
                                       @(Model.AvatarID == avatar.AvatarID ? "checked" : null) />
                                <label for="avatar_@avatar.AvatarID" class="d-block">
                                    <img src="@avatar.ImageUrl" alt="@avatar.Name" class="rounded border"
                                         style="max-width: 100px;" />
                                </label>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    </div>

    <div class="mt-3">
        <button type="submit" class="btn btn-primary">儲存變更</button>
    </div>
</form>

@section Scripts {
    @{ await Html.RenderPartialAsync("_ValidationScriptsPartial"); }
    <script>
        (function () {
            const input = document.getElementById('AvatarFile');
            const preview = document.getElementById('avatarPreview');
            if (!input || !preview) return;

            input.addEventListener('change', function (e) {
                const files = e.target.files;
                if (files && files.length > 0) {
                    const file = files[0];
                    preview.src = URL.createObjectURL(file);
                }
            });
        })();
    </script>
}
